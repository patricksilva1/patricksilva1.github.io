<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study</title>
  <style>
    :root{--bg:#0b0b0b;--card:#0f0f0f;--muted:#9a9a9a}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#eaeaea;margin:0;padding:24px}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    p{color:var(--muted);margin:6px 0 18px}
    .card{background:var(--card);border:1px solid #222;border-radius:10px;padding:14px}
    ul{list-style:none;padding:0;margin:0}
    li{padding:10px;border-bottom:1px solid #161616;display:flex;justify-content:space-between;align-items:center}
    .name{flex:1;padding-right:12px;cursor:pointer}
    .name:hover{text-decoration:underline;}
    #status{margin-bottom:12px;}
    #fileList{margin-top:18px;}
    .pagination{display:flex;justify-content:center;align-items:center;margin:18px 0;flex-wrap:wrap;}
    .pagination button{background:#222;color:#eaeaea;border:none;padding:6px 12px;margin:0 2px 4px 2px;border-radius:4px;cursor:pointer;}
    .pagination button[disabled]{opacity:0.4;cursor:not-allowed;}
    .pagination .page-info{margin:0 10px;color:var(--muted);}
    .pagination .page-btn.active{background:#444;color:#fff;font-weight:bold;}
    .search-box{margin-bottom:12px;}
    .search-input{padding:6px 10px;border-radius:4px;border:1px solid #333;background:#181818;color:#eaeaea;width:100%;max-width:320px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Study</h1>
    </header>
    <div id="status"></div>
    <div class="card">
      <div class="search-box">
        <input id="searchInput" class="search-input" type="text" placeholder="Buscar por nome do PDF..." autocomplete="off">
      </div>
      <ul id="fileList"></ul>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script src="files.js"></script>
  <script>
const PAGE_SIZE = 15;
let currentPage = 1;
let filteredFiles = files || [];

function showStatus(msg, warn = false) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = warn ? '#f6b' : '#8f8';
}

function renderList(files, page = 1) {
  const list = document.getElementById('fileList');
  list.innerHTML = '';
  const start = (page - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageFiles = files.slice(start, end);

  if (pageFiles.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'Nenhum arquivo encontrado.';
    list.appendChild(li);
  }

  pageFiles.forEach(file => {
    const li = document.createElement('li');
    const name = document.createElement('span');
    name.className = 'name';
    let displayName = file.name.split('/').pop().replace(/\.pdf$/i, '');
    name.textContent = displayName;
    name.title = file.name;

    const btn = document.createElement('button');
    btn.textContent = 'Open';
    btn.onclick = (e) => {
      e.stopPropagation();
      showOptions(file);
    };

    name.onclick = btn.onclick;

    li.appendChild(name);
    // li.appendChild(btn);
    list.appendChild(li);
  });

  renderPagination(files.length, page);
}

function showOptions(file) {
  let old = document.getElementById('modal-options');
  if (old) old.remove();

  const modal = document.createElement('div');
  modal.id = 'modal-options';
  Object.assign(modal.style, {
    position: 'fixed', left: 0, top: 0, width: '100vw', height: '100vh',
    background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000
  });

  const box = document.createElement('div');
  Object.assign(box.style, {
    background: '#181818', padding: '24px', borderRadius: '8px', minWidth: '260px', boxShadow: '0 2px 16px #000'
  });

  const title = document.createElement('div');
  title.textContent = 'Choose';
  title.style.marginBottom = '18px';
  box.appendChild(title);

  const openBtn = document.createElement('button');
  openBtn.textContent = 'Open';
  openBtn.style.marginRight = '12px';
  openBtn.onclick = () => {
    window.open(file.path, '_blank');
    modal.remove();
  };
  box.appendChild(openBtn);

  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Download';
  downloadBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = file.path;
    a.download = file.name.split('/').pop() + '.enc';
    document.body.appendChild(a);
    a.click();
    a.remove();
    modal.remove();
  };
  box.appendChild(downloadBtn);

  // const cancelBtn = document.createElement('button');
  // cancelBtn.textContent = 'Cancel';
  // cancelBtn.style.marginLeft = '18px';
  // cancelBtn.onclick = () => modal.remove();
  // box.appendChild(cancelBtn);

  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  modal.appendChild(box);
  document.body.appendChild(modal);
}

async function getKeyFromPassword(pass, salt){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:150000,hash:'SHA-256'}, baseKey,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}

async function decryptAndOpen(url, pass){
  const resp = await fetch(url);
  if(!resp.ok) throw new Error('fetch failed: '+resp.status);
  const data = new Uint8Array(await resp.arrayBuffer());
  if(data.byteLength < 28) throw new Error('arquivo curto');
  const salt = data.slice(0,16);
  const iv = data.slice(16,28);
  const ct = data.slice(28);
  const key = await getKeyFromPassword(pass, salt);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, ct);
  const blob = new Blob([plain], {type:'application/pdf'});
  const urlObj = URL.createObjectURL(blob);
  window.open(urlObj, '_blank');
}

function renderPagination(total, page) {
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const pag = document.getElementById('pagination');
  pag.innerHTML = '';

  if (totalPages <= 1) return;

  const first = document.createElement('button');
  first.textContent = '«';
  first.disabled = page === 1;
  first.title = 'First Page';
  first.onclick = () => {
    currentPage = 1;
    renderList(filteredFiles, currentPage);
  };
  pag.appendChild(first);

  const prev = document.createElement('button');
  prev.textContent = '‹';
  prev.disabled = page === 1;
  prev.title = 'Previous Page';
  prev.onclick = () => {
    currentPage--;
    renderList(filteredFiles, currentPage);
  };
  pag.appendChild(prev);

  let startPage = Math.max(1, page - 3);
  let endPage = Math.min(totalPages, page + 3);
  if (page <= 4) endPage = Math.min(7, totalPages);
  if (page > totalPages - 4) startPage = Math.max(1, totalPages - 6);

  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = 'page-btn' + (i === page ? ' active' : '');
    btn.disabled = i === page;
    btn.onclick = () => {
      currentPage = i;
      renderList(filteredFiles, currentPage);
    };
    pag.appendChild(btn);
  }

  const next = document.createElement('button');
  next.textContent = '›';
  next.disabled = page === totalPages;
  next.title = 'Next Page';
  next.onclick = () => {
    currentPage++;
    renderList(filteredFiles, currentPage);
  };
  pag.appendChild(next);

  const last = document.createElement('button');
  last.textContent = '»';
  last.disabled = page === totalPages;
  last.title = 'Last Page';
  last.onclick = () => {
    currentPage = totalPages;
    renderList(filteredFiles, currentPage);
  };
  pag.appendChild(last);

  const pageInfo = document.createElement('span');
  pageInfo.className = 'page-info';
  pageInfo.textContent = `Page ${page} of ${totalPages}`;
  pag.appendChild(pageInfo);
}

function filterFiles(query) {
  if (!query) return files;
  query = query.toLowerCase();
  return files.filter(f => f.name.toLowerCase().includes(query));
}

function load() {
  if (!files || files.length === 0) {
    showStatus('Not found.', true);
    return;
  }
  // showStatus('Filled.');
  renderList(filteredFiles, currentPage);
}

document.getElementById('searchInput').addEventListener('input', function(e) {
  const query = e.target.value;
  filteredFiles = filterFiles(query);
  currentPage = 1;
  renderList(filteredFiles, currentPage);
});

load();
</script>
</body>
</html>
